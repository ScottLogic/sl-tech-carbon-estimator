name: Publish new package
on:
  workflow_dispatch:
concurrency:
  group: 'publish'
  cancel-in-progress: false
jobs:
  # TODO - Reinstate before merging
  # test:
  #   uses: ./.github/workflows/buildAndTest.yml

  publish:
    runs-on: ubuntu-latest
    # TODO - Reinstate before merging
    # needs: 
    #   - test
    permissions:
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      - name: Set up environment
        uses: ./.github/actions/set-up-environment
      - name: Prepare package
        run: npm run prepare
      - name: Run Semantic-Release
        env:
          GH_TOKEN: ${{ github.token }}
          NPM_TOKEN: ${{secrets.NPM_TOKEN}}
        # TODO: Remove dry run parameter before merge
        run: npx semantic-release --dryRun
      - name: Verify release
        run: npm run verify-release

  publish_pages:
    needs: publish
    permissions:
      pages: write
      id-token: write
      contents: read
    uses: ./.github/workflows/shared-pages.yml
