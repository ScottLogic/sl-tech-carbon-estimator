<form (ngSubmit)="handleSubmit()" [formGroup]="estimatorForm" class="w-full flex flex-col gap-12">
  <div formGroupName="upstream">
    <ng-container *ngTemplateOutlet="sectionHeader; context: formContext.upstream"></ng-container>

    <div class="flex flex-col gap-4">
      <div class="flex flex-col gap-2">
        <label class="text-sm text-slate-600" for="headCount">How many employees are in the organisation? </label>
        <input
          id="headCount"
          class="border border-slate-400 rounded"
          formControlName="headCount"
          name="headCount"
          type="number"
          min="1" />
      </div>

      <div class="flex flex-col gap-2">
        <label for="desktopPercentage" class="text-sm text-slate-600">
          What percentage of those employee devices are desktops or laptops?
        </label>
        <label for="desktopPercentage" class="flex justify-between text-sm text-slate-600"
          ><span>Desktops {{ desktopPercentage }}%</span><span>Laptops {{ laptopPercentage }}%</span></label
        >

        <input
          id="desktopPercentage"
          class="mt-1 block w-full"
          formControlName="desktopPercentage"
          name="desktopPercentage"
          type="range"
          min="0"
          max="100"
          step="5" />
      </div>
    </div>
  </div>

  <div formGroupName="onPremise">
    <ng-container *ngTemplateOutlet="sectionHeader; context: formContext.onPremise"></ng-container>

    <div class="flex flex-col gap-4">
      <p>How many on-premise servers do you use?</p>
      <div class="flex gap-2 items-center">
        <input
          id="directUnknown"
          type="checkbox"
          class="rounded-sm"
          [(ngModel)]="directUnknown"
          (ngModelChange)="directUnknownChange()"
          [ngModelOptions]="{ standalone: true }" />
        <label for="directUnknown" class="cursor-pointer select-none">I don't know</label>
      </div>

      @if (directUnknown) {
        <sl-note>
          <p>
            We'll use an assumption that there are a number of servers totalling 10% of your number of employees (=
            {{ headCount * 0.1 | number: '1.0-0' }} on-prem servers).
          </p>
        </sl-note>
      }

      <div class="flex flex-col gap-2">
        <label class="text-sm text-slate-600" for="numberOfServers">Number of Servers:</label>
        <input
          id="numberOfServers"
          class="border border-slate-400 rounded disabled:bg-gray-200 disabled:text-slate-400 disabled:cursor-not-allowed"
          formControlName="numberOfServers"
          name="numberOfServers"
          type="number"
          min="0" />
      </div>

      <ng-container *ngTemplateOutlet="locationInput; context: formContext.onPremise"></ng-container>
    </div>
  </div>

  <div formGroupName="cloud">
    <ng-container *ngTemplateOutlet="sectionHeader; context: formContext.cloud"></ng-container>

    <div class="flex flex-col gap-4">
      <div class="flex gap-2 items-center">
        <input id="noCloudServices" type="checkbox" formControlName="noCloudServices" class="rounded-sm" />
        <label for="noCloudServices" class="cursor-pointer select-none">We don't use cloud services</label>
      </div>

      @if (!noCloudServices) {
        <div class="flex flex-col gap-2">
          <label for="cloudPercentage" class="text-sm text-slate-600"
            >What percentage of your servers are cloud services vs on-premise?</label
          >
          <label for="cloudPercentage" class="flex justify-between text-sm text-slate-600">
            <span>Cloud {{ cloudPercentage }}%</span>
            <span>On-prem {{ onPremisePercentage }}%</span>
          </label>
          <input
            id="cloudPercentage"
            class="disabled:bg-gray-200 disabled:text-slate-400 disabled:cursor-not-allowed"
            formControlName="cloudPercentage"
            name="cloudPercentage"
            type="range"
            min="0"
            max="100"
            step="5" />
        </div>

        <ng-container *ngTemplateOutlet="locationInput; context: formContext.cloud"></ng-container>

        <div>
          <p>
            We have derived a rough figure to give a ratio from US dollars spent to kWh of energy used in data centres.
          </p>
        </div>

        <div class="flex flex-col gap-2">
          <label for="monthlyCloudBill" class="text-sm text-slate-600">What is your monthly cloud bill?</label>
          <select
            id="monthlyCloudBill"
            class="border border-slate-400 rounded disabled:bg-gray-200 disabled:text-slate-400 disabled:cursor-not-allowed"
            formControlName="monthlyCloudBill"
            name="monthlyCloudBill"
            required>
            <option value="0-200" selected>$0-$200</option>
            <option value="200-500">$200-$500</option>
            <option value="500-1000">$500-$1000</option>
            <option value="1000-5000">$1000-$5000</option>
            <option value="5000-10000">$5000-$10000</option>
            <option value="10000-50000">$10000-$50000</option>
          </select>
        </div>
      }
    </div>
  </div>

  <div formGroupName="downstream">
    <ng-container *ngTemplateOutlet="sectionHeader; context: formContext.downstream"></ng-container>
    <div class="flex flex-col gap-4">
      <!-- <label for="customerLocation" class="text-sm text-slate-600">Where are your users primarily located?</label>
      <select
        class="border border-slate-400 rounded"
        name="customerLocation"
        formControlName="customerLocation"
        id="customerLocation">
        <option value="global" selected>Global</option>
        <option value="uk">in the UK</option>
        <option value="eu">in the EU</option>
        <option value="us">in the US</option>
      </select> -->

      <ng-container *ngTemplateOutlet="locationInput; context: formContext.downstream"></ng-container>

      <div class="flex flex-col gap-2">
        <label for="monthlyActiveUsers" class="text-sm text-slate-600">
          How many monthly active users does your website have?
        </label>
        <input
          class="border border-slate-400 rounded"
          formControlName="monthlyActiveUsers"
          name="monthlyActiveUsers"
          type="number"
          id="monthlyActiveUsers"
          min="0" />
      </div>

      <div class="flex flex-col gap-2">
        <label for="mobilePercentage" class="text-sm text-slate-600">
          What percentage of your users are mobile or personal computer users?
        </label>
        <label for="mobilePercentage" class="flex justify-between text-sm text-slate-600">
          <span>Mobile {{ mobilePercentage }}%</span>
          <span>Computer {{ computerPercentage }}%</span>
        </label>
        <input
          id="mobilePercentage"
          formControlName="mobilePercentage"
          name="mobilePercentage"
          type="range"
          min="0"
          max="100"
          step="5" />
      </div>

      <div class="flex flex-col gap-2">
        <div class="flex">
          <label for="purposeOfSite" class="text-sm text-slate-600">What's the purpose of your website?</label>
          <ng-container *ngTemplateOutlet="helperTextPopup; context: { text: helperText.purposeOfSite }"></ng-container>
        </div>
        <select
          class="border border-slate-400 rounded"
          formControlName="purposeOfSite"
          name="purposeOfSite"
          id="purposeOfSite">
          <option value="average" selected>Average</option>
          <option value="streaming">Streaming</option>
          <option value="information">Information</option>
          <option value="eCommerce">E-Commerce</option>
          <option value="socialMedia">Social Media</option>
        </select>
      </div>
    </div>
  </div>

  <div class="flex gap-4 flex-row-reverse">
    <button
      class="px-3 py-2 bg-sky-800 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed"
      type="submit"
      [disabled]="!estimatorForm.valid">
      Calculate
    </button>
    <button class="px-3 py-2 bg-slate-200 text-slate-800 rounded" type="button" (click)="resetForm()">Reset</button>
  </div>

  <ng-template
    #locationInput
    let-label="location.label"
    let-hasUnknown="location.hasUnknown"
    let-formControlName="location.formControlName"
    let-formGroupName="formGroupName">
    <div formGroupName="{{ formGroupName }}" class="flex flex-col gap-2">
      <label for="{{ formControlName }}" class="text-sm text-slate-600">{{ label }} </label>
      <select
        class="border border-slate-400 rounded"
        name="{{ formControlName }}"
        formControlName="{{ formControlName }}"
        id="{{ formControlName }}">
        <option value="global" selected>Globally</option>
        <option value="uk">in the UK</option>
        <option value="eu">in the EU</option>
        <option value="us">in the US</option>
        @if (hasUnknown) {
          <option value="unknown">I don't know</option>
        }
      </select>
      @if (estimatorForm.get(formGroupName + '.' + formControlName)?.value === 'unknown') {
        <sl-note>
          <p>We'll use the assumption that any servers you use are located globally.</p>
        </sl-note>
      }
    </div>
  </ng-template>

  <ng-template #sectionHeader let-heading="heading" let-sectionDetails="details">
    <div class="flex justify-between gap-2 flex-col mb-4">
      <h2 class="text-xl">{{ heading }}</h2>
      <!-- <span class="material-symbols-outlined">{{ expandUpstream ? 'expand_less' : 'expand_more' }}</span> -->
      <div>
        <p>{{ sectionDetails }}</p>
      </div>
    </div>
  </ng-template>
</form>

<ng-template #helperTextPopup let-helperText="text">
  <button [satPopoverAnchor]="helperInfo" (click)="helperInfo.toggle()" class="ml-auto" type="button">
    <span class="material-icons-outlined text-sm text-slate-600">help_outline</span>
  </button>

  <sat-popover #helperInfo verticalAlign="above" hasBackdrop>
    <div
      class="max-w-64 bg-white border border-slate-600 rounded p-2 before:w-4 before:h-4 before:rotate-45 before:bg-slate-600 before:absolute before:z-[-10] before:-bottom-1 before:left-0 before:right-0 before:mx-auto">
      <p class="text-sm text-slate-600">
        {{ helperText }}
      </p>
    </div>
  </sat-popover>
</ng-template>
